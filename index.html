<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Crypto Candle AI Pro</title>

<!-- Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {margin:0;font-family:Arial,sans-serif;background:#0b0e11;color:#eaecef;}
header{padding:10px;background:#161a1e;display:flex;justify-content:space-between;align-items:center;gap:10px;}
select, button{background:#0b0e11;color:#eaecef;border:1px solid #2b3139;padding:5px;border-radius:5px;cursor:pointer;}
#chart{height:50vh;}
#aiBox{position:fixed;bottom:15px;right:15px;width:360px;background:#161a1e;border-radius:12px;padding:12px;box-shadow:0 0 15px rgba(0,0,0,0.6);font-size:13px;overflow-y:auto;max-height:45vh;}
#aiTitle{font-weight:bold;margin-bottom:6px;color:#0ecb81;}
.signalScore{font-weight:700;margin-bottom:6px;}
.chatHistory{margin-top:10px;border-top:1px solid #2b3139;padding-top:6px;max-height:150px;overflow-y:auto;font-size:12px;}
.favoriteBtn{margin-left:5px;padding:3px 6px;font-size:11px;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>

<body>

<header>
  <div>üìä Crypto Candle AI Pro</div>
  <select id="symbol">
    <option value="BTCUSDT">BTC / USDT</option>
    <option value="ETHUSDT">ETH / USDT</option>
    <option value="BNBUSDT">BNB / USDT</option>
  </select>
  <select id="timeframe">
    <option value="1m">1‚ÄØm</option>
    <option value="5m">5‚ÄØm</option>
    <option value="15m">15‚ÄØm</option>
  </select>
  <button id="favoritesBtn">‚≠ê Favorites</button>
</header>

<div id="chart"></div>

<div id="aiBox">
  <div id="aiTitle">ü§ñ KI-Analyse</div>
  <div class="signalScore" id="signalScore">KI-Score: --</div>
  <div id="aiText">Warte auf erste Kerze‚Ä¶</div>
  <div class="chatHistory" id="chatHistory"></div>
</div>

<script>
// ==================== Setup Chart ====================
const chart = LightweightCharts.createChart(document.getElementById('chart'), {
    layout: {background:{color:'#0b0e11'},textColor:'#eaecef'},
    grid: {vertLines:{color:'#161a1e'},horzLines:{color:'#161a1e'}},
    timeScale:{borderColor:'#2b3139'},rightPriceScale:{borderColor:'#2b3139'}
});
const candleSeries = chart.addCandlestickSeries({upColor:'#0ecb81',downColor:'#f6465d',borderUpColor:'#0ecb81',borderDownColor:'#f6465d',wickUpColor:'#0ecb81',wickDownColor:'#f6465d'});

let candles=[], lastTime=0, favorites=[], showFavorites=false;

// ==================== Load Candle Data ====================
async function loadData(symbol, tf){
  const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${tf}&limit=100`);
  const data = await res.json();
  candles = data.map(c=>({time:c[0]/1000,open:+c[1],high:+c[2],low:+c[3],close:+c[4]}));
  candleSeries.setData(candles);
  lastTime = candles[candles.length-1].time;
}

// ==================== Candle Analyse ====================
function analyzeCandle(c,p){
  const body = Math.abs(c.close-c.open), range=c.high-c.low;
  const upShadow=c.high-Math.max(c.open,c.close), lowShadow=Math.min(c.open,c.close)-c.low;
  const isBull = c.close>c.open;
  let text="", score=50;

  // Einzelmuster
  if(body<=range*0.1){ text+='üü° Doji:\nMarkt unentschlossen.\n\n'; score+=0; }
  if(lowShadow>body*2 && isBull){ text+='üü¢ Hammer:\nBodenbildung m√∂glich. Kaufsignal.\n\n'; score+=15; }
  if(upShadow>body*2 && !isBull){ text+='üî¥ Shooting Star:\nTop m√∂glich, Verkaufsdruck.\n\n'; score-=15; }

  // Engulfing
  if(p){
    const prevBull = p.close>p.open;
    const prevBear = p.close<p.open;
    if(prevBear && isBull && c.close>p.open && c.open<p.close){ text+='üöÄ Bullish Engulfing:\nTrendwende nach oben.\nHandlung: Kauf erw√§gen.\n\n'; score+=20; }
    if(prevBull && !isBull && c.open>p.close && c.close<p.open){ text+='‚ö†Ô∏è Bearish Engulfing:\nTrendwende nach unten.\nHandlung: Verkauf erw√§gen.\n\n'; score-=20; }
  }

  // Erweiterte Muster
  if(c.close>c.open && body>range*0.6 && p && p.close>p.open && candles[candles.indexOf(c)-2] && candles[candles.indexOf(c)-2].close>candles[candles.indexOf(c)-2].open){
    text+='üåÖ Three White Soldiers:\nStarker Aufw√§rtstrend.\nHandlung: Kauf stark.\n\n'; score+=25; }
  if(!isBull && body>range*0.6 && p && p.close<p.open && candles[candles.indexOf(c)-2] && candles[candles.indexOf(c)-2].close<p.open){
    text+='üåÑ Three Black Crows:\nStarker Abw√§rtstrend.\nHandlung: Verkauf stark.\n\n'; score-=25; }

  if(!text) text='‚ÑπÔ∏è Normale Kerze: Kein spezielles Muster erkannt.';

  score = Math.min(Math.max(score,0),100);
  return {text,score};
}

// ==================== Update Loop ====================
async function updateLoop(){
  const symbol = document.getElementById('symbol').value;
  const tf = document.getElementById('timeframe').value;
  const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${tf}&limit=2`);
  const data = await res.json();
  const last = {time:data[1][0]/1000,open:+data[1][1],high:+data[1][2],low:+data[1][3],close:+data[1][4]};

  if(last.time!==lastTime){
    candles.push(last);
    candleSeries.update(last);

    const prev = candles[candles.length-2];
    const analysis = analyzeCandle(last, prev);

    document.getElementById('aiText').textContent=analysis.text;
    document.getElementById('signalScore').textContent=`KI-Score: ${analysis.score}%`;

    // Chat-History
    const chat = document.getElementById('chatHistory');
    const msg = document.createElement('div');
    msg.textContent = `[${new Date().toLocaleTimeString()}] ${analysis.text}`;
    chat.prepend(msg);

    // Alert bei starker Signale
    if(analysis.score>=80 || analysis.score<=20) alert(`‚ö° Starke Signal! KI-Score: ${analysis.score}%`);

    lastTime = last.time;
  }
}

// ==================== Favorites ====================
document.getElementById('favoritesBtn').addEventListener('click',()=>{
  showFavorites=!showFavorites;
  if(showFavorites){
    const symbolSelect=document.getElementById('symbol');
    symbolSelect.innerHTML='';
    favorites.forEach(f=>{
      const o=document.createElement('option'); o.value=f; o.textContent=f.replace('USDT',' / USDT'); symbolSelect.appendChild(o);
    });
  } else {
    location.reload();
  }
});

// ==================== Events ====================
document.getElementById('symbol').addEventListener('change',()=>loadData(document.getElementById('symbol').value));
document.getElementById('timeframe').addEventListener('change',()=>loadData(document.getElementById('symbol').value));

// ==================== Start ====================
loadData('BTCUSDT','1m');
setInterval(updateLoop,5000);
</script>

</body>
</html>
